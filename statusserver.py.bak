#!/usr/bin/env python

import RPi.GPIO as gpio
from flask import Flask, render_template
from time import sleep

app = Flask(__name__)

gpio.setmode(gpio.BCM)
gpio.setwarnings(False)

green = 2
red = 3
button = 4

gpio.setup(button, gpio.IN, pull_up_down=gpio.PUD_DOWN)
gpio.setup(green, gpio.OUT, initial=gpio.HIGH)
gpio.setup(red, gpio.OUT, initial=gpio.LOW)

def setBusy():
  gpio.output(red, gpio.HIGH)
  gpio.output(green, gpio.LOW)
  
def setFree():
  gpio.output(green, gpio.HIGH)
  gpio.output(red, gpio.LOW)

def swap_state():
  if gpio.input(green):
    setBusy()
  else:
    setFree()

#try:
#  while True:
#    if gpio.input(button) == gpio.HIGH:
#      swap_state()
#    sleep(.200)
#
#except KeyboardInterrupt:
#  pass
#
#finally:
#  gpio.cleanup([green, red, button])         # clean up GPIO on normal exit


@app.route("/")
def index():
  templateData = {
    'title' : 'GPIO input Status!',
    'green'   : gpio.input(green),
    'red'     : gpio.input(red)
  }
  return render_template('index.html', **templateData)

@app.route("/<status>")
def action(status):
  if status == 'busy':
    print("calling setBusy()")
    setBusy()
  if status == 'free': 
    print("calling setFree()")
    setFree()
  templateData = {
    'title' : 'GPIO input Status!',
    'green'   : gpio.input(green),
    'red'     : gpio.input(red)
  }
  return render_template('index.html', **templateData)

if __name__ == "__main__":
  app.run(host='0.0.0.0', port=80, debug=True)
